angular.module("ion-image-search",["ionic"]).directive("hideOnFail",function(){return{link:function a(b,c){c.bind("error",function(){angular.element(this).parent().css("display","none")})}}}).service("$webImageSelector",["$rootScope","$ionicModal","$injector","$q","$log","$timeout","ionImageSearchProviders","ionImageSearchDefaultConfiguration",function(e,b,m,p,l,s,c,a){var g=c;var h=a;var i=null;var d=null;var k=null;var o=1;var j=0;var t=null;var f=null;var u='<form name="web-search"><ion-modal-view><div class="bar bar-header item-input-inset"><input type="submit" ng-click="submitSearch(search.text)" style="position: absolute; left: -9999px; width: 1px; height: 1px;"/><button class="button button-icon" ng-click="onCancel()"><i class="ion-android-arrow-back"></i></button><label class="item-input-wrapper"><i class="icon ion-ios-search placeholder-icon"></i><input type="search" placeholder="Search..." ng-model="search.text"></label><button class="button button-stable button-clear" ng-click="onClearSearch()"><i class="ion-close-round"></i></button></div><ion-content class="has-header" ng-class="{\'ion-web-image-content\': displayedImages.length==0}"><div ng-show="!searching&&(displayedImages.length==0)" class="ion-web-image-no-images">No results</div><div ng-show="searching&&(displayedImages.length==0)" class="ion-web-image-no-images"><ion-spinner class="ios"></ion-spinner></div><div ng-hide="displayedImages.length==0"><ul><li class="ion-web-image-li" ng-hide="image.hide" ng-repeat="image in displayedImages track by $index" ng-click="onImageClicked(image)"><img class="ion-web-image-image" hide-on-fail ng-src="{{image.url}}"></li></ul><ion-infinite-scroll ng-if="!stopAutoLoad" on-infinite="loadMoreImages()" distance="1%" immediate-check="true"></ion-infinite-scroll></div></ion-content></ion-modal-view></form>';var r=function(){o=1;j=0;f=null;i=null;k.search={};k.search.text="";k.displayedImages=[];k.searching=false};var n=function(){k=e.$new();var v=function(y){if(y&&y.length>0){y.forEach(function(z){k.displayedImages.push(z)})}};var x=function(y){return(typeof y.query==="function")&&(typeof y.getPageSize==="function")};var w=function(){if(j>=h.maxSuccessiveFails){var z=i.index+1;if(z<h.searchProviders.length){l.warn("Switching search providers to: "+h.searchProviders[z]);var y=new (m.get(h.searchProviders[z]))(h);if(x(y)){i={provider:y,index:z,name:h.searchProviders[z]};j=0}else{throw new Error("Illegal Search Provider: "+h.searchProviders[z]+". Please see ReadMe for expected provider")}}else{k.stopAutoLoad=true}}};k.loadMoreImages=function(){try{if(f&&f.length>0){var z=i.provider;l.info("loadedImages from: "+o+" to: "+(o+z.getPageSize()));z.query(f,o).then(function(A){o+=i.provider.getPageSize();v(A);l.debug("loaded images successfully");s(function(){k.$broadcast("scroll.infiniteScrollComplete")},100)},function(){l.debug("failed loading images");j++;w();if(!k.stopAutoLoad&&k.displayedImages.length==0){k.loadMoreImages()}else{k.$broadcast("scroll.infiniteScrollComplete");k.searching=false}})}else{l.debug("Empty search submitted")}}catch(y){l.error(y.toString())}};k.submitSearch=function(){try{cordova.plugins.Keyboard.close()}catch(y){l.warn("failed to close keyboard")}k.displayedImages=[];j=0;o=1;k.stopAutoLoad=false;f=k.search.text;k.searching=true;k.loadMoreImages()};k.onClearSearch=function(){f=null;k.search.text=""};k.onCancel=function(){d.remove();d=null;t.reject()};k.onHideImage=function(y){y.hide=true};k.onImageClicked=function(y){d.remove();d=null;t.resolve({image:y,searchString:f})};r()};var q=function(v){t=p.defer();r();if(v){for(var x in v){if(v.hasOwnProperty(x)){h[x]=v[x]}}}if(h.searchProviders.length>0){var w=new (m.get(h.searchProviders[0]))(h);i={provider:w,index:0,name:h.searchProviders[0]};if(!d){d=b.fromTemplate(u,{scope:k,animation:"slide-in-up"})}k.stopAutoLoad=false;d.show()}else{l.error("Please supply service providers to use");t.reject("Please supply service providers to use")}return t.promise};n();return{show:q,searchProviders:g}}]);angular.module("ion-image-search").factory("googleSearch",["$injector","$q","$http","$log",function(i,e,h,j){var g=function(l){var k=this;if(!l||!l.fileType||!l.imgSize){throw new Error("Search provider must be constructed with proper configuration")}k.configuration=l};var b=i.get("googleParams");var c=function(k){return(k&&k.data)};var d=function(l){var m=[];for(var k in l){if(l.hasOwnProperty(k)){m.push(encodeURIComponent(k)+"="+encodeURIComponent(l[k]))}}return m.join("&")};var f=function(l,m){var k={};k.q=l;k.key=b.key;k.safe="high";k.cx=b.customSearch;k.searchType="image";k.fileType=this.configuration.fileType;k.imgSize=this.configuration.imgSize;k.start=m;return b.address+d(k)};var a=function(l){var k=[];if(l.items&&l.items.length>0){l.items.forEach(function(m){k.push({url:m.link})})}else{j.warn("returned no images")}return k};g.prototype.query=function(n,o){var k=e.defer();var m={};var l=f.call(this,n,o);h.get(l,m).then(function(q){if(c(q)){var p=a(q.data,k);if(p&&p.length>0){k.resolve(p)}else{k.reject()}}else{j.warn("returned no data");k.reject()}},function(p){var q=(p&&p.data&&p.data.error)?p.data.error.message:((p)?p.toString():"no message");j.warn("Failed getting images "+q);k.reject()});return k.promise};g.prototype.getPageSize=function(){return b.pageSize};return g}]);angular.module("ion-image-search").factory("bingSearch",["$injector","$q","$http","$log",function(i,e,g,j){var h=function(l){var k=this;if(!l||!l.fileType||!l.imgSize){throw new Error("Search provider must be constructed with proper configuration")}k.configuration=l};var b=i.get("bingParams");var c=function(k){return(k&&k.data&&k.data.d)};var d=function(l){var m=[];for(var k in l){if(l.hasOwnProperty(k)){m.push(encodeURIComponent(k)+"="+encodeURIComponent(l[k]))}}return m.join("&")};var f=function(m,n){var l={};l.Query="'"+m+"'";l.Adult="'Strict'";var k=this.configuration.imgSize;k=k.charAt(0).toUpperCase()+k.slice(1);l.ImageFilters="'Size:"+k.toString()+"+Aspect:Square'";l["$skip"]=n;return b.address+d(l)};var a=function(l){var k=[];if(l.d&&l.d.results&&l.d.results.length>0){l.d.results.forEach(function(m){k.push({url:m.Thumbnail.MediaUrl})})}else{j.warn("returned no images")}return k};h.prototype.query=function(n,o){var k=e.defer();var m={};m.headers={Authorization:b.auth};var l=f.call(this,n,o);g.get(l,m).then(function(q){if(c(q)){var p=a(q.data,k);if(p&&p.length>0){k.resolve(p)}else{k.reject()}}else{j.warn("returned no data");k.reject()}},function(p){var q=(p&&p.data)?p.data:"No Error";j.warn("Failed getting images "+q);k.reject()});return k.promise};h.prototype.getPageSize=function(){return b.pageSize};return h}]);angular.module("ion-image-search").factory("flickrSearch",["$injector","$q","$http","$log",function(i,e,h,j){var g=function(l){var k=this;if(!l||!l.fileType||!l.imgSize){throw new Error("Search provider must be constructed with proper configuration")}k.configuration=l};var a=i.get("flickrParams");var c=function(k){return(k&&k.data&&k.data.stat!=="fail")};var d=function(l){var m=[];for(var k in l){if(l.hasOwnProperty(k)){m.push(encodeURIComponent(k)+"="+encodeURIComponent(l[k]))}}return m.join("&")};var f=function(l,m){var k={};k.api_key=a.key;k.text=l;k.privacy_filter="public";k.content_type="7";k.media="photos";k.format="json";k.per_page=a.pageSize;k.page=m;k.extras="url_m";return a.address+d(k)};var b=function(m){if(m.photos&&m.photos.photo&&m.photos.photo.length>0){var k=[];var l="url_m";m.photos.photo.forEach(function(n){k.push({url:n[l]})})}else{j.warn("returned no images")}return k};g.prototype.query=function(n,o){var k=e.defer();var m={};var l=f.call(this,n,o);h.get(l,m).then(function(q){q.data=q.data.replace("jsonFlickrApi(","");q.data=q.data.slice(0,-1);q.data=JSON.parse(q.data);if(c(q)){var p=b(q.data,k);if(p&&p.length>0){k.resolve(p)}else{k.reject()}}else{j.warn("returned no data");if(q.data.stat==="fail"){j.warn("Error: "+q.data.message)}k.reject()}},function(p){var q=(p&&p.data)?p.data:"No Error";j.warn("Failed getting images "+q);k.reject()});return k.promise};g.prototype.getPageSize=function(){return a.pageSize};return g}]);